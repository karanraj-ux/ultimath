<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JEE COMMANDER // APEX EDITION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --panel: #0a0a0a;
            --border: #222;
            --primary: #00f3ff; /* Cyan */
            --accent: #ff003c;  /* Red */
            --warn: #fbbf24;    /* Gold */
            --success: #00ff9d; /* Green */
            --burn: #ff5e00;    /* Phoenix Orange */
            --text-main: #eee;
            --text-dim: #666;
            --font-head: 'Rajdhani', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font-mono);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; height: 100%; width: 100%; position: relative; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 80px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 20;
        }

        .nav-btn {
            width: 50px; height: 50px; margin-bottom: 20px;
            border-radius: 10px; border: 1px solid transparent;
            background: transparent; color: var(--text-dim);
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: all 0.2s;
        }

        .nav-btn.active {
            background: rgba(0, 243, 255, 0.1); border-color: var(--primary);
            color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

        .nav-label { font-size: 8px; margin-top: 4px; font-family: var(--font-head); font-weight: bold; letter-spacing: 1px; }

        /* --- MAIN VIEW --- */
        .main-view { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        .view-section {
            display: none; height: 100%; overflow-y: auto; padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HEADERS --- */
        h1, h2, h3 { font-family: var(--font-head); text-transform: uppercase; margin: 0; }
        .cyber-header {
            border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .cyber-header h1 { font-size: 32px; letter-spacing: 2px; color: white; }
        .cyber-header span { color: var(--primary); font-size: 12px; letter-spacing: 1px; }

        /* --- CARDS --- */
        .card {
            background: #0f0f0f; border: 1px solid var(--border);
            border-radius: 4px; padding: 20px; margin-bottom: 20px; position: relative;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: var(--border); }
        .card.priority-high::before { background: var(--primary); }
        .card.priority-crit::before { background: var(--accent); }

        /* --- SYLLABUS GRID --- */
        .tracker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

        .chapter-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #161616; padding: 15px; border: 1px solid var(--border);
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .chapter-item:hover { border-color: var(--text-dim); }
        
        /* PHOENIX PROTOCOL STYLES */
        .chapter-item.done { border-color: var(--success); }
        .chapter-item.done::after {
            content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--success);
        }
        
        .chapter-item.revive { border-color: var(--burn); box-shadow: inset 0 0 20px rgba(255, 94, 0, 0.1); }
        .chapter-item.revive::after {
            content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--burn);
        }

        .chap-info h3 { font-size: 16px; color: var(--text-main); }
        .chap-info p { font-size: 10px; color: var(--text-dim); margin-top: 4px; }
        
        .status-badge { font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .badge-done { background: rgba(0, 255, 157, 0.1); color: var(--success); }
        .badge-revive { background: rgba(255, 94, 0, 0.2); color: var(--burn); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* --- CHAT --- */
        .chat-container { display: flex; flex-direction: column; height: 90%; background: #0f0f0f; border: 1px solid var(--border); }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 4px; font-size: 14px; line-height: 1.5; }
        .msg.user { align-self: flex-end; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); }
        .msg.ai { align-self: flex-start; background: #1a1a1a; border: 1px solid #333; color: #eee; }
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        textarea { flex: 1; background: #000; border: 1px solid var(--border); color: white; padding: 10px; font-family: var(--font-mono); resize: none; outline: none; }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary); color: #000; border: none; padding: 10px 20px;
            font-family: var(--font-head); font-weight: 700; cursor: pointer; text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn:hover { background: #fff; }
        .btn-combat { background: #333; color: var(--text-main); border: 1px solid var(--text-dim); }
        .btn-combat:hover { border-color: var(--accent); color: var(--accent); }
        
        /* VOICE MIC BUTTON */
        .btn-mic { 
            width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--primary);
            background: transparent; color: var(--primary); cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-mic.recording { background: var(--accent); color: white; border-color: var(--accent); animation: pulse 1s infinite; }

        /* --- STATS --- */
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: #111; border: 1px solid var(--border); padding: 15px; text-align: center; }
        .stat-val { font-size: 32px; font-family: var(--font-head); font-weight: 700; color: white; }
        .stat-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; }

        /* --- PROTOCOL TIMER --- */
        #timer-display {
            font-size: 80px; font-family: var(--font-head); font-weight: 700; text-align: center;
            color: var(--text-main); text-shadow: 0 0 20px rgba(0,0,0,0.5); margin: 40px 0;
        }
        .timer-container {
            display:flex; flex-direction:column; align-items:center; justify-content:center; height:70%;
            transition: background 0.5s; border-radius: 8px;
        }
        /* Combat Mode Colors */
        .combat-phase-1 { border: 2px solid var(--success); background: rgba(0, 255, 157, 0.05); }
        .combat-phase-2 { border: 2px solid var(--warn); background: rgba(251, 191, 36, 0.05); }
        .combat-phase-3 { border: 2px solid var(--accent); background: rgba(255, 0, 60, 0.05); }
        
        .combat-label { font-size: 14px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 3px; }

        /* --- CALCULATOR --- */
        #calculator-panel {
            position: absolute; bottom: 20px; right: 20px; width: 300px; background: #111;
            border: 1px solid var(--primary); padding: 10px; display: none; z-index: 100;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .calc-display { width: 100%; background: #000; color: var(--primary); font-family: var(--font-mono); font-size: 24px; text-align: right; border: 1px solid var(--border); padding: 10px; margin-bottom: 10px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .calc-btn { background: #222; color: white; border: none; padding: 10px; cursor: pointer; font-family: var(--font-mono); }
        .calc-btn:hover { background: #333; }
        .calc-btn.op { background: #333; color: var(--primary); }
        .calc-btn.eq { background: var(--primary); color: black; }

        /* --- BLACK BOX --- */
        .mistake-input { width: 100%; background: #111; border: 1px solid var(--border); color: white; padding: 10px; margin-bottom: 10px; font-family: var(--font-mono); }
        .mistake-list { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .mistake-item { background: #0f0f0f; border-left: 3px solid var(--accent); padding: 15px; position: relative; }
        .delete-mistake { position: absolute; top: 10px; right: 10px; color: #666; cursor: pointer; }

        /* --- LOCKDOWN OVERLAY (GATEKEEPER) --- */
        #lockdown-overlay {
            position: absolute; inset: 0; background: black; z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .lock-glitch { font-size: 40px; color: var(--accent); font-family: var(--font-head); animation: pulse 0.2s infinite; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; border-right: none; border-top: 1px solid var(--border); justify-content: space-around; padding: 0; }
            .nav-btn { margin: 0; border: none; height: 100%; width: 100%; border-radius: 0; }
            .nav-btn.active { border-top: 2px solid var(--primary); box-shadow: none; background: rgba(0,0,0,0.5); }
            .view-section { padding: 15px; padding-bottom: 80px; }
            .stats-row { flex-direction: column; gap: 10px; }
            #calculator-panel { bottom: 80px; right: 10px; width: 280px; }
        }
    </style>
</head>
<body>

<div id="lockdown-overlay">
    <div class="lock-glitch">WAKE UP COMMANDER</div>
    <div style="color:#666; margin-bottom:20px; font-size:12px;">SCAN QR TO ACCESS WAR ROOM</div>
    <div id="qr-reader" style="width:300px; border:2px solid var(--accent);"></div>
</div>

<div class="app-container">
    
    <div class="sidebar">
        <button class="nav-btn active" onclick="switchView('dashboard')">
            <i data-lucide="layout-dashboard"></i>
            <span class="nav-label">COMMAND</span>
        </button>
        <button class="nav-btn" onclick="switchView('syllabus')">
            <i data-lucide="target"></i>
            <span class="nav-label">TARGETS</span>
        </button>
        <button class="nav-btn" onclick="switchView('tutor')">
            <i data-lucide="bot"></i>
            <span class="nav-label">ADVISOR</span>
        </button>
        <button class="nav-btn" onclick="switchView('blackbox')">
            <i data-lucide="alert-triangle"></i>
            <span class="nav-label">DEBRIEF</span>
        </button>
        <button class="nav-btn" onclick="switchView('protocol')">
            <i data-lucide="timer"></i>
            <span class="nav-label">FOCUS</span>
        </button>
        <button class="nav-btn" onclick="toggleCalculator()">
            <i data-lucide="calculator"></i>
            <span class="nav-label">CALC</span>
        </button>
    </div>

    <div class="main-view">
        
        <div id="view-dashboard" class="view-section active">
            <div class="cyber-header">
                <h1>WAR ROOM</h1>
                <span>STATUS: <span style="color:var(--accent)">CRITICAL</span></span>
            </div>

            <div class="stats-row">
                <div class="stat-box" style="border-color: var(--primary);">
                    <div class="stat-val" id="score-target">140+</div>
                    <div class="stat-lbl">MISSION TARGET</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="days-left">--</div>
                    <div class="stat-lbl">DAYS REMAINING</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="syllabus-prog">0%</div>
                    <div class="stat-lbl">SYLLABUS COMPLETED</div>
                </div>
            </div>

            <div class="card priority-crit">
                <h3>‚ö†Ô∏è THE "KILL LIST" (DO NOT STUDY)</h3>
                <p style="font-size:12px; color:#888; margin-bottom:10px;">Officially Deleted. Ignored by average students.</p>
                <div style="display:flex; flex-wrap:wrap; gap:5px;" id="kill-list-container"></div>
            </div>

            <div class="card">
                <h3>üìà 2025 TREND ANALYSIS</h3>
                <canvas id="trendChart" style="max-height: 250px; margin-top:15px;"></canvas>
            </div>
            
            <div style="margin-top:20px;">
                <label style="font-size:10px; color:#666;">GATEKEEPER ALARM (24H Format)</label>
                <div style="display:flex; gap:10px;">
                    <input type="time" id="alarm-time" class="mistake-input">
                    <button class="btn" onclick="App.setAlarm()">ARM</button>
                </div>
            </div>
        </div>

        <div id="view-syllabus" class="view-section">
            <div class="cyber-header">
                <h1>PHOENIX PROTOCOL</h1>
                <span>TRACKER + FORGETTING CURVE MONITOR</span>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto;">
                <button class="btn" onclick="renderSyllabus('physics')" style="flex:1;">PHYSICS</button>
                <button class="btn" onclick="renderSyllabus('chemistry')" style="flex:1;">CHEMISTRY</button>
                <button class="btn" onclick="renderSyllabus('maths')" style="flex:1;">MATHS</button>
            </div>

            <div id="tracker-container" class="tracker-grid"></div>
        </div>

        <div id="view-tutor" class="view-section" style="padding:0;">
            <div class="chat-container">
                <div style="padding:15px; border-bottom:1px solid var(--border); background:#111;">
                    <h3 style="color:var(--primary);">TACTICAL ADVISOR</h3>
                    <span style="font-size:10px; color:#666;">ACCESSING STRATEGIC DATABASE...</span>
                </div>
                <div class="chat-history" id="chat-history">
                    <div class="msg ai">
                        Commander. I am ready. I can help you with strategy or analyze your "Black Box" errors.
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="user-input" rows="1" placeholder="Type query..."></textarea>
                    <button class="btn" onclick="sendMessage()"><i data-lucide="send"></i></button>
                </div>
            </div>
        </div>

        <div id="view-blackbox" class="view-section">
            <div class="cyber-header">
                <h1>THE BLACK BOX</h1>
                <span>MISTAKE AUTOPSY & LOGS</span>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom:15px; color:var(--warn);">ADD NEW ERROR RECORD</h3>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <input type="text" id="mistake-topic" class="mistake-input" placeholder="Topic (e.g., Rotation - Torque)" style="margin-bottom:0; flex:1;">
                    <button class="btn-mic" id="mic-btn" onclick="toggleMic()">
                        <i data-lucide="mic"></i>
                    </button>
                </div>
                <textarea id="mistake-desc" class="mistake-input" rows="3" placeholder="What went wrong? (Or speak to log)"></textarea>
                <button class="btn" onclick="App.addMistake()">LOG ERROR</button>
            </div>

            <h3 style="margin-top:30px;">ERROR DATABASE</h3>
            <div id="mistake-container" class="mistake-list"></div>
        </div>

        <div id="view-protocol" class="view-section">
            <div class="cyber-header">
                <h1>PROTOCOL MODE</h1>
                <span>DEEP WORK & COMBAT SIMULATION</span>
            </div>

            <div class="timer-container" id="timer-bg">
                <div class="combat-label" id="combat-phase-text" style="color:var(--text-dim)">READY</div>
                <div id="timer-display">00:00:00</div>
                
                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <button class="btn" onclick="startTimer(50, 'study')">50 MIN (STUDY)</button>
                    <button class="btn" onclick="startTimer(10, 'break')">10 MIN (BREAK)</button>
                </div>

                <button class="btn btn-combat" onclick="startCombatTimer()" style="width:200px; border-color:var(--accent); color:var(--accent);">
                    ‚öîÔ∏è 3 HR MOCK SIM
                </button>

                <div class="card" style="width:100%; max-width:400px; text-align:center; margin-top:30px;">
                    <ul style="text-align:left; font-size:12px; color:#aaa; margin:0; padding-left:15px; line-height:1.6;">
                        <li>1. PHONE IS LOCKED.</li>
                        <li>2. 3 HR MOCK: Green = Chem, Yellow = Phy, Red = Maths.</li>
                        <li>3. SWITCHING TABS = SIREN (COMBAT MODE).</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <div id="calculator-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="font-size:10px; color:var(--primary);">ORDNANCE CALC</span>
            <span style="cursor:pointer; color:red;" onclick="toggleCalculator()">[X]</span>
        </div>
        <input type="text" id="calc-display" class="calc-display" readonly>
        <div class="calc-grid">
            <button class="calc-btn op" onclick="calcInput('sin(')">sin</button>
            <button class="calc-btn op" onclick="calcInput('cos(')">cos</button>
            <button class="calc-btn op" onclick="calcInput('tan(')">tan</button>
            <button class="calc-btn op" onclick="calcClear()">C</button>
            <button class="calc-btn op" onclick="calcInput('log(')">log</button>
            <button class="calc-btn op" onclick="calcInput('(')">(</button>
            <button class="calc-btn op" onclick="calcInput(')')">)</button>
            <button class="calc-btn op" onclick="calcInput('/')">/</button>
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn op" onclick="calcInput('*')">*</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn op" onclick="calcInput('-')">-</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn op" onclick="calcInput('+')">+</button>
            <button class="calc-btn" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn op" onclick="calcInput('Math.PI')">œÄ</button>
            <button class="calc-btn eq" onclick="calcSolve()">=</button>
        </div>
    </div>
</div>

<script>
    // --- DATABASE WITH PHOENIX PROTOCOL SUPPORT ---
    const STRATEGY_DB = {
        killList: [ "Communication Systems", "Transistors", "Potentiometer", "Carnot Engine", "Newton's Cooling", "S-Block", "Polymers", "Env Chemistry", "Solid State", "Metallurgy", "Planes (3D)", "Math Reasoning" ],
        physics: [
            { id: 'p1', name: "Ray Optics", weight: "High", subtopics: "Lens Maker, Prism", done: false, lastDone: null },
            { id: 'p2', name: "Modern Physics", weight: "High", subtopics: "De-Broglie, Photoelectric", done: false, lastDone: null },
            { id: 'p3', name: "Units & Dims", weight: "Med", subtopics: "Error Analysis", done: false, lastDone: null },
            { id: 'p4', name: "Current Elec", weight: "High", subtopics: "Meter Bridge, Galv", done: false, lastDone: null },
            { id: 'p5', name: "Thermodynamics", weight: "Med", subtopics: "Work, Efficiency", done: false, lastDone: null },
            { id: 'p6', name: "Semiconductors", weight: "Guaranteed", subtopics: "Logic Gates", done: false, lastDone: null },
            { id: 'p7', name: "Electrostatics", weight: "High", subtopics: "Dipole, Flux", done: false, lastDone: null }
        ],
        chemistry: [
            { id: 'c1', name: "Coordination", weight: "Very High", subtopics: "CFT, Hybridization", done: false, lastDone: null },
            { id: 'c2', name: "GOC", weight: "High", subtopics: "Acidity, Stability", done: false, lastDone: null },
            { id: 'c3', name: "Bonding", weight: "High", subtopics: "MOT, VSEPR", done: false, lastDone: null },
            { id: 'c4', name: "Electrochem", weight: "Med", subtopics: "Nernst Eq", done: false, lastDone: null },
            { id: 'c5', name: "Biomolecules", weight: "Free Marks", subtopics: "Structure Memorization", done: false, lastDone: null },
            { id: 'c6', name: "d & f Block", weight: "Med", subtopics: "KMnO4 reactions", done: false, lastDone: null }
        ],
        maths: [
            { id: 'm1', name: "Vector & 3D", weight: "CRITICAL", subtopics: "Shortest Distance", done: false, lastDone: null },
            { id: 'm2', name: "Matrices", weight: "High", subtopics: "Cramer's Rule", done: false, lastDone: null },
            { id: 'm3', name: "Statistics", weight: "Guaranteed", subtopics: "Variance", done: false, lastDone: null },
            { id: 'm4', name: "Seq & Series", weight: "Med", subtopics: "AP/GP, Sigma", done: false, lastDone: null },
            { id: 'm5', name: "Binomial", weight: "Med", subtopics: "General Term", done: false, lastDone: null },
            { id: 'm6', name: "Functions", weight: "High", subtopics: "Domain/Range", done: false, lastDone: null }
        ]
    };

    const App = {
        activeTab: 'physics',
        mistakes: [],
        alarmTime: localStorage.getItem('apex_alarm') || null,
        
        init: function() {
            lucide.createIcons();
            this.renderKillList();
            this.renderSyllabus('physics');
            this.initChart();
            this.loadProgress();
            this.loadMistakes();
            
            // Alarm Check Loop
            setInterval(() => this.checkAlarm(), 10000); 
            if(this.alarmTime) document.getElementById('alarm-time').value = this.alarmTime;
            
            // Calc days left
            const examDate = new Date('2026-01-24'); 
            const today = new Date();
            const diffTime = examDate - today; 
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            document.getElementById('days-left').innerText = diffDays > 0 ? diffDays : 0;
            
            // Visbility listener for Combat Mode
            document.addEventListener("visibilitychange", () => {
                if(document.hidden && combatActive) {
                    playSiren();
                    alert("COMBAT BREACH DETECTED. FOCUS!");
                }
            });
        },

        renderKillList: function() {
            const container = document.getElementById('kill-list-container');
            STRATEGY_DB.killList.forEach(item => {
                const tag = document.createElement('span');
                tag.style.cssText = "font-size:10px; padding:4px 8px; border:1px solid #333; color:#666; text-decoration:line-through;";
                tag.innerText = item;
                container.appendChild(tag);
            });
        },

        // --- PHOENIX PROTOCOL RENDERER ---
        renderSyllabus: function(subject) {
            this.activeTab = subject;
            const container = document.getElementById('tracker-container');
            container.innerHTML = '';
            
            const now = new Date();

            STRATEGY_DB[subject].forEach(chapter => {
                let statusHtml = '';
                let extraClass = '';
                let daysSince = 0;

                if (chapter.done && chapter.lastDone) {
                    const lastDate = new Date(chapter.lastDone);
                    const diffTime = Math.abs(now - lastDate);
                    daysSince = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (daysSince >= 7) {
                        extraClass = 'revive';
                        statusHtml = `<span class="status-badge badge-revive">üî• REVIVE (${daysSince}d)</span>`;
                    } else {
                        extraClass = 'done';
                        statusHtml = `<span class="status-badge badge-done">MASTERED</span>`;
                    }
                } else {
                    statusHtml = `<span style="font-size:18px;">‚¨ú</span>`;
                }

                const div = document.createElement('div');
                div.className = `chapter-item ${extraClass}`;
                div.onclick = () => this.toggleChapter(subject, chapter.id);
                div.innerHTML = `
                    <div class="chap-info">
                        <h3>${chapter.name}</h3>
                        <p>FOCUS: ${chapter.subtopics}</p>
                    </div>
                    <div class="chap-meta">
                        <div class="chap-weight" style="margin-bottom:5px;">${chapter.weight}</div>
                        ${statusHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        },

        toggleChapter: function(sub, id) {
            const chapter = STRATEGY_DB[sub].find(c => c.id === id);
            
            if (!chapter.done) {
                chapter.done = true;
                chapter.lastDone = new Date().toISOString();
            } else {
                const now = new Date();
                const lastDate = new Date(chapter.lastDone);
                const daysSince = Math.ceil(Math.abs(now - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince >= 7) {
                    chapter.lastDone = new Date().toISOString();
                } else {
                    chapter.done = false;
                    chapter.lastDone = null;
                }
            }

            this.saveProgress();
            this.renderSyllabus(sub);
            this.updateTotalProgress();
        },

        updateTotalProgress: function() {
            let total = 0, done = 0;
            ['physics', 'chemistry', 'maths'].forEach(sub => {
                STRATEGY_DB[sub].forEach(c => {
                    total++;
                    if(c.done) done++;
                });
            });
            const pct = Math.round((done / total) * 100);
            document.getElementById('syllabus-prog').innerText = pct + "%";
        },

        saveProgress: function() {
            localStorage.setItem('jee_commander_ult', JSON.stringify(STRATEGY_DB));
        },

        loadProgress: function() {
            const saved = localStorage.getItem('jee_commander_ult');
            if(saved) {
                const data = JSON.parse(saved);
                ['physics', 'chemistry', 'maths'].forEach(sub => {
                    STRATEGY_DB[sub].forEach(c => {
                        const savedChap = data[sub].find(sc => sc.id === c.id);
                        if(savedChap) {
                            c.done = savedChap.done;
                            c.lastDone = savedChap.lastDone;
                        }
                    });
                });
                this.updateTotalProgress();
            }
        },

        // --- BLACK BOX & VOICE ---
        addMistake: function() {
            const topic = document.getElementById('mistake-topic').value;
            const desc = document.getElementById('mistake-desc').value;
            if(!topic && !desc) return alert("Empty Log");
            
            this.mistakes.push({ 
                id: Date.now(), 
                topic: topic || "Voice Note", 
                desc: desc || topic, 
                date: new Date().toLocaleDateString() 
            });
            localStorage.setItem('jee_mistakes', JSON.stringify(this.mistakes));
            this.renderMistakes();
            document.getElementById('mistake-topic').value = '';
            document.getElementById('mistake-desc').value = '';
        },
        loadMistakes: function() {
            const saved = localStorage.getItem('jee_mistakes');
            if(saved) this.mistakes = JSON.parse(saved);
            this.renderMistakes();
        },
        renderMistakes: function() {
            const container = document.getElementById('mistake-container');
            container.innerHTML = '';
            this.mistakes.slice().reverse().forEach(m => {
                const div = document.createElement('div');
                div.className = 'mistake-item';
                div.innerHTML = `
                    <div style="color:var(--primary); font-size:12px; font-weight:bold;">${m.topic}</div>
                    <div style="color:#ccc; margin-top:5px; font-size:14px;">${m.desc}</div>
                    <div style="color:#555; font-size:10px; margin-top:10px;">${m.date}</div>
                    <span class="delete-mistake" onclick="App.deleteMistake(${m.id})">üóëÔ∏è</span>
                `;
                container.appendChild(div);
            });
        },
        deleteMistake: function(id) {
            this.mistakes = this.mistakes.filter(m => m.id !== id);
            localStorage.setItem('jee_mistakes', JSON.stringify(this.mistakes));
            this.renderMistakes();
        },

        // --- GATEKEEPER ALARM ---
        setAlarm: function() {
            const t = document.getElementById('alarm-time').value;
            if(t) {
                this.alarmTime = t;
                localStorage.setItem('apex_alarm', t);
                alert("GATEKEEPER ARMED.");
            }
        },
        checkAlarm: function() {
            if(!this.alarmTime) return;
            const now = new Date();
            const current = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            if(current === this.alarmTime) {
                this.triggerLockdown();
            }
        },
        triggerLockdown: function() {
            const overlay = document.getElementById('lockdown-overlay');
            overlay.style.display = 'flex';
            playSiren();
            
            const scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
            scanner.render((decodedText) => {
                scanner.clear();
                overlay.style.display = 'none';
                stopSiren();
                this.alarmTime = null; 
                localStorage.removeItem('apex_alarm');
                alert("ACCESS GRANTED.");
            });
        },
        
        initChart: function() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Optics', 'Modern', 'GOC', 'Coord', 'Vectors', 'Stats'],
                    datasets: [{
                        label: 'Weightage', data: [23, 20, 22, 22, 18, 16], 
                        backgroundColor: 'rgba(0, 243, 255, 0.4)'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
            });
        }
    };

    // --- VOICE RECOGNITION ---
    let recognition;
    function toggleMic() {
        if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
        const btn = document.getElementById('mic-btn');
        
        if (btn.classList.contains('recording')) {
            recognition.stop();
            btn.classList.remove('recording');
        } else {
            recognition = new webkitSpeechRecognition();
            recognition.lang = "en-US";
            recognition.onresult = (e) => {
                document.getElementById('mistake-desc').value = e.results[0][0].transcript;
                btn.classList.remove('recording');
            };
            recognition.start();
            btn.classList.add('recording');
        }
    }

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let osc = null;

    function playSiren() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        osc = audioCtx.createOscillator();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(500, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 1);
        osc.connect(audioCtx.destination);
        osc.start();
    }
    function stopSiren() {
        if(osc) { osc.stop(); osc = null; }
    }

    // --- TIMERS & COMBAT MODE ---
    let timerInterval = null;
    let timerTime = 0;
    let combatActive = false;
    
    window.startTimer = (minutes, mode) => {
        resetTimerUI();
        const display = document.getElementById('timer-display');
        timerTime = minutes * 60;
        combatActive = false;
        
        timerInterval = setInterval(() => {
            updateDisplay(display);
            if(timerTime <= 0) stopTimer(display);
            timerTime--;
        }, 1000);
    };

    window.startCombatTimer = () => {
        resetTimerUI();
        const display = document.getElementById('timer-display');
        const bg = document.getElementById('timer-bg');
        const label = document.getElementById('combat-phase-text');
        
        timerTime = 180 * 60;
        const totalTime = timerTime;
        combatActive = true;
        
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();

        timerInterval = setInterval(() => {
            updateDisplay(display);
            
            const elapsed = (totalTime - timerTime) / 60; 
            
            if (elapsed < 40) {
                bg.className = 'timer-container combat-phase-1';
                label.innerText = "PHASE 1: CHEMISTRY ATTACK (SPEED)";
                label.style.color = "var(--success)";
            } else if (elapsed < 100) {
                bg.className = 'timer-container combat-phase-2';
                label.innerText = "PHASE 2: PHYSICS (ACCURACY)";
                label.style.color = "var(--warn)";
            } else {
                bg.className = 'timer-container combat-phase-3';
                label.innerText = "PHASE 3: MATHS (SURVIVAL)";
                label.style.color = "var(--accent)";
            }

            if(timerTime <= 0) stopTimer(display);
            timerTime--;
        }, 1000);
    };

    function updateDisplay(display) {
        const h = Math.floor(timerTime / 3600).toString().padStart(2, '0');
        const m = Math.floor((timerTime % 3600) / 60).toString().padStart(2, '0');
        const s = (timerTime % 60).toString().padStart(2, '0');
        display.innerText = `${h}:${m}:${s}`;
    }

    function stopTimer(display) {
        clearInterval(timerInterval);
        display.innerText = "COMPLETE";
        combatActive = false;
        const osc = audioCtx.createOscillator();
        osc.connect(audioCtx.destination);
        osc.start(); setTimeout(() => osc.stop(), 1000);
    }

    function resetTimerUI() {
        if(timerInterval) clearInterval(timerInterval);
        const bg = document.getElementById('timer-bg');
        const label = document.getElementById('combat-phase-text');
        bg.className = 'timer-container';
        label.innerText = "READY";
        label.style.color = "#666";
    }

    // --- AI CHAT ---
    const AiEngine = {
        keyPartA: "AIzaSy", keyPartB: "CMxc3KUDKp4ZtKBy91vqB6IfPG_48064c", 
        async send(userText) {
            const historyDiv = document.getElementById('chat-history');
            const userMsg = document.createElement('div'); userMsg.className = 'msg user'; userMsg.innerText = userText;
            historyDiv.appendChild(userMsg);
            const loadMsg = document.createElement('div'); loadMsg.className = 'msg ai'; loadMsg.innerText = "Analyzing...";
            historyDiv.appendChild(loadMsg); historyDiv.scrollTop = historyDiv.scrollHeight;

            const context = `ACT AS: Elite JEE Commander. USER: Dropper, Exam 45 days. STRATEGY: Vectors, Ray Optics, Modern Phy are king. QUERY: ${userText}`;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.keyPartA + this.keyPartB}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] }) });
                const data = await response.json();
                historyDiv.removeChild(loadMsg);
                const aiMsg = document.createElement('div'); aiMsg.className = 'msg ai'; aiMsg.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
                historyDiv.appendChild(aiMsg); historyDiv.scrollTop = historyDiv.scrollHeight;
            } catch (e) { loadMsg.innerText = "Offline Mode active."; }
        }
    };
    function sendMessage() { const i = document.getElementById('user-input'); if(i.value.trim()) { AiEngine.send(i.value.trim()); i.value = ''; } }

    // --- UTILS ---
    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const btns = document.querySelectorAll('.nav-btn');
        if(id=='dashboard') btns[0].classList.add('active');
        if(id=='syllabus') btns[1].classList.add('active');
        if(id=='tutor') btns[2].classList.add('active');
        if(id=='blackbox') btns[3].classList.add('active');
        if(id=='protocol') btns[4].classList.add('active');
    };

    let calcVisible = false;
    window.toggleCalculator = () => {
        const p = document.getElementById('calculator-panel');
        calcVisible = !calcVisible; p.style.display = calcVisible ? 'block' : 'none';
    };
    window.calcInput = (v) => document.getElementById('calc-display').value += v;
    window.calcClear = () => document.getElementById('calc-display').value = '';
    window.calcSolve = () => { try { with(Math){ document.getElementById('calc-display').value = eval(document.getElementById('calc-display').value); } } catch(e){ document.getElementById('calc-display').value = 'ERR'; } };

    // Anti-Cheat Title
    document.addEventListener("visibilitychange", () => {
        document.title = document.hidden && timerInterval ? "‚ö†Ô∏è RETURN TO BASE" : "JEE COMMANDER";
    });

    App.init();

</script>
</body>
</html>