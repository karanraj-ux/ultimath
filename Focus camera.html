<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural Focus Guardian: Pro Performance</title>
    <style>
        /* --- PRO UI STYLING --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Camera Section */
        #container {
            position: relative;
            width: 100%;
            height: 60%;
            background-color: #0a0a0a;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mirrored Video Feed */
        video {
            height: 100%;
            width: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.8; 
            z-index: 1;
        }

        /* Bottom Dashboard Section */
        #panel {
            height: 40%;
            width: 100%;
            background-color: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 15px;
            box-sizing: border-box;
            z-index: 10;
            transition: background-color 0.4s ease;
        }

        h1 {
            font-size: 2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        p {
            margin: 5px 0 15px 0;
            color: #888;
            font-size: 0.9rem;
        }

        /* Scrollable System Log */
        #logs {
            width: 90%;
            height: 80px;
            background-color: #111;
            border: 1px solid #333;
            color: #aaa;
            font-size: 0.75rem;
            padding: 10px;
            overflow-y: auto;
            text-align: left;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Dynamic Status Colors */
        .status-good { color: #00ff00; text-shadow: 0 0 15px #00ff00; }
        .status-bad { color: #ff3333; text-shadow: 0 0 15px #ff3333; }
        .status-wait { color: #ffff00; }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #00ff00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        <div id="loader" class="spinner"></div>
    </div>

    <div id="panel">
        <h1 id="mainStatus" class="status-wait">SYSTEM BOOT</h1>
        <p id="subStatus">Initializing Neural Engine...</p>
        <div id="logs">> [SYSTEM] Power On.<br></div>
    </div>

    <script>
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';
        let isRunning = false;

        // Logging Utility
        function log(msg) {
            console.log(msg);
            const logBox = document.getElementById('logs');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            logBox.innerHTML = `> [${time}] ${msg}<br>` + logBox.innerHTML;
        }

        // 1. STARTUP SEQUENCE
        function initApp() {
            log("Core Library Loaded.");
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.innerText = "LOADING AI...";
            
            // Load only the essential light models
            Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
            ]).then(startCamera).catch(err => {
                log("CRITICAL ERROR: " + err);
                mainStatus.innerText = "NETWORK ERROR";
                mainStatus.className = "status-bad";
                alert("Could not download AI models. Check internet.");
            });
        }

        // 2. CAMERA SETUP (Optimized for Mobile Performance)
        function startCamera() {
            log("AI Models Ready. Requesting Camera...");
            
            // KEY UPGRADE: We ask for 320x240 resolution. 
            // This is crystal clear for AI but 4x faster for your CPU than HD.
            const constraints = {
                audio: false,
                video: {
                    facingMode: "user",
                    width: { ideal: 320 },
                    height: { ideal: 240 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    const container = document.getElementById('container');
                    const loader = document.getElementById('loader');
                    loader.style.display = 'none'; // Hide spinner

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.autoplay = true;
                    video.playsInline = true;
                    video.muted = true;
                    container.appendChild(video);

                    video.onloadedmetadata = () => {
                        log("Camera Active. Engine Started.");
                        runDetectionEngine(video);
                    };
                })
                .catch(err => {
                    log("CAMERA BLOCKED: " + err.message);
                    document.getElementById('mainStatus').innerText = "NO CAMERA";
                    document.getElementById('mainStatus').className = "status-bad";
                });
        }

        // 3. THE DETECTION ENGINE (The Brain)
        function runDetectionEngine(video) {
            const mainStatus = document.getElementById('mainStatus');
            const subStatus = document.getElementById('subStatus');
            const panel = document.getElementById('panel');

            // PERFORMANCE TUNING: inputSize 160 is the secret.
            // It processes a smaller image internally for maximum speed.
            const aiOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.3 });

            mainStatus.innerText = "SCANNING...";
            mainStatus.className = "status-wait";

            // Loop every 500ms (2 times per second)
            // This is the perfect balance: Smooth updates, Zero lag.
            setInterval(async () => {
                if (video.paused || video.ended) return;

                // Detect Face & Landmarks
                const result = await faceapi.detectSingleFace(video, aiOptions).withFaceLandmarks();

                if (result) {
                    // Face Found - Calculate Tilt
                    const landmarks = result.landmarks;
                    const leftEye = landmarks.getLeftEye();
                    const rightEye = landmarks.getRightEye();

                    // Get average points
                    const leftY = leftEye.reduce((sum, p) => sum + p.y, 0) / leftEye.length;
                    const rightY = rightEye.reduce((sum, p) => sum + p.y, 0) / rightEye.length;
                    const leftX = leftEye.reduce((sum, p) => sum + p.x, 0) / leftEye.length;
                    const rightX = rightEye.reduce((sum, p) => sum + p.x, 0) / rightEye.length;

                    // Math: Angle Calculation
                    const dy = rightY - leftY;
                    const dx = rightX - leftX;
                    const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                    const absAngle = Math.abs(angle);

                    // Update UI
                    subStatus.innerText = "Head Tilt: " + absAngle.toFixed(1) + "Â°";

                    if (absAngle > 20) {
                        // BAD POSTURE
                        mainStatus.innerText = "BAD POSTURE";
                        mainStatus.className = "status-bad";
                        panel.style.backgroundColor = "#330000"; // Red Flash
                    } else {
                        // GOOD POSTURE
                        mainStatus.innerText = "FOCUSED";
                        mainStatus.className = "status-good";
                        panel.style.backgroundColor = "#002200"; // Green Glow
                    }

                } else {
                    // No Face Found
                    mainStatus.innerText = "NO FACE";
                    mainStatus.className = "status-wait";
                    subStatus.innerText = "Please look at the camera";
                    panel.style.backgroundColor = "#050505"; // Reset Black
                }

            }, 500); // 500ms Interval = Smooth & Fast
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" 
            onload="initApp()" 
            onerror="alert('Failed to load AI library. Check AdBlock or Connection.')">
    </script>

</body>
</html>
