<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMEGA v29 (QR + ANIM)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --hue: 45; --primary: #fbbf24; --bg: #050505; --text: #fff; --font: 'Courier New', monospace; --cyan: #00f3ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; text-transform: uppercase; }
        
        /* FX */
        .crt { position: fixed; inset: 0; pointer-events: none; z-index: 100; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: var(--bg); z-index: 10; }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .strobe { animation: strobe 0.1s infinite; }
        @keyframes strobe { 0% { background: #000; } 50% { background: #fff; } 100% { background: #f00; } }
        
        /* UI */
        .btn { background: rgba(251, 191, 36, 0.1); border: 1px solid var(--primary); color: var(--primary); padding: 18px; width: 100%; max-width: 300px; margin-top: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; display: flex; align-items: center; justify-content: center; text-align: left; }
        .btn:active { background: var(--primary); color: #000; }
        .inp { background: #111; border: 1px solid #444; color: white; width: 100%; padding: 15px; margin-bottom: 15px; text-align: center; font-size: 18px; letter-spacing: 2px; }
        
        .status-badge { font-size: 10px; padding: 5px 10px; background: #111; border: 1px solid #333; margin-bottom: 20px; }
        
        /* ADMIN BTN */
        #admin-trigger { margin-top: 50px; font-size: 12px; color: #444; border: 1px dashed #333; padding: 10px 20px; cursor: pointer; transition: color 0.5s; user-select: none; }
        #admin-trigger.holding { color: var(--primary); border-color: var(--primary); }

        /* DENIAL SCREEN */
        .denial-box { border: 2px solid red; padding: 20px; text-align: center; background: rgba(50,0,0,0.5); display: none; }

        /* ID DISPLAY & QR */
        .id-box { font-size: 10px; color: #444; border: 1px solid #333; padding: 5px; background: #000; margin-bottom: 10px; cursor: pointer; }
        #qrcode { margin: 10px auto; border: 4px solid #fff; padding: 5px; background: #fff; }

        /* SYNC ANIMATION STYLES */
        .sync-box { width: 100%; max-width: 300px; border: 1px solid #333; padding: 20px; text-align: center; position: relative; }
        .sync-icon { font-size: 40px; margin-bottom: 20px; color: var(--cyan); }
        .progress-bar { width: 100%; height: 4px; background: #333; margin: 20px 0; position: relative; }
        .progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--cyan); width: 0%; transition: width 0.2s; }
        .log-text { font-size: 10px; color: #666; font-family: monospace; height: 60px; overflow: hidden; text-align: left; }

    </style>
</head>
<body>

<div class="crt"></div>

<div id="view-home" class="screen active">
    <div id="qrcode"></div>
    <div class="id-box" onclick="copyId()">ID: <span id="disp-peer-id">Generating...</span> (TAP TO COPY)</div>

    <h1 style="font-size:50px; color:var(--primary); font-weight:900; margin-bottom:10px;">LOCKED</h1>
    <div style="font-size:10px; margin-bottom:30px;">OMEGA v29 PROTOCOL</div>
    
    <div class="status-badge" id="net-stat">OFFLINE MODE</div>
    
    <button class="btn" onclick="startFlow()">STUDENT UNLOCK</button>
    <div style="margin-top:20px; font-size:10px; color:#666;">
        UNLOCKS TODAY: <span id="unlock-count">0</span>/2<br>
        TAB SWITCHES: <span id="cheat-count">0</span>/3
    </div>
    
    <div id="admin-trigger" onmousedown="startHold()" ontouchstart="startHold()" onmouseup="endHold()" ontouchend="endHold()">
        ADMIN ACCESS (HOLD 5s)
    </div>
</div>

<div id="view-auth" class="screen">
    <h2>ADMIN CONSOLE</h2>
    <div id="device-warning" class="denial-box" onclick="bypassDenial()">
        <div style="color:red; font-size:20px; font-weight:bold; margin-bottom:10px;">ACCESS DENIED</div>
        <div style="font-size:10px;">
            UNAUTHORIZED DEVICE DETECTED.<br>
            ALLOWED: SAMSUNG SM-F415 / SM-E236<br>
            CURRENT: <span id="user-agent-disp">GENERIC ANDROID</span>
        </div>
    </div>

    <div id="admin-login-area">
        <input type="password" id="admin-pass" class="inp" placeholder="PASSWORD">
        <button class="btn" onclick="verifyAdmin()">AUTHENTICATE</button>
    </div>
    
    <button class="btn" onclick="location.reload()" style="border-color:#444; color:#666; margin-top:20px;">CANCEL</button>
</div>

<div id="view-quiz" class="screen">
    <div style="width:100%; max-width:400px; border:1px solid var(--primary); padding:20px;">
        <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:20px;">
            <span>Q <span id="q-idx">1</span>/<span id="q-total">10</span></span>
            <span id="quiz-type">THEORY</span>
        </div>
        <div id="q-text" style="min-height:50px; font-weight:bold; margin-bottom:20px; font-size:16px; line-height: 1.4;">Loading...</div>
        <div id="mc-area"></div>
    </div>
</div>

<div id="view-wait" class="screen">
    <div style="color:orange; animation:pulse 1s infinite; margin-bottom:20px;">PERMISSION REQUIRED</div>
    <div style="font-size:12px; text-align:center;">QUOTA EXCEEDED.<br>WAITING FOR ADMIN...</div>
</div>

<div id="view-anim" class="screen">
    <div class="sync-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="color:var(--primary);">PROTOCOL</div>
            <div style="font-size:20px;">&harr;</div>
            <div style="color:var(--cyan);">APPLOCK</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="anim-bar"></div></div>
        <div class="log-text" id="anim-log">INITIATING HANDSHAKE...</div>
    </div>
</div>

<div id="view-reveal" class="screen">
    <div style="font-size:12px; color:#0f0; margin-bottom:10px;">ACCESS GRANTED</div>
    
    <div id="final-pin" style="font-size:80px; font-weight:900; margin-bottom:20px;">----</div>
    
    <div style="font-size:10px; color:#666;">LOGIC: OFFSET + HOUR</div>
    <div style="font-size:10px; color:#444; margin-top:5px;">(Type 25 in Offset for 2511 format)</div>
    
    <div style="color:orange; font-size:12px; margin-top:20px;">SESSION STARTING IN 5s...</div>
</div>

<div id="view-session" class="screen">
    <div style="width:250px; height:250px; border: 4px solid #333; border-radius: 50%; display:flex; align-items:center; justify-content:center;">
        <div id="sess-time" style="font-size:60px;">45:00</div>
    </div>
    <div style="margin-top:30px; font-size:12px;">SENTINEL MONITORING...</div>
</div>

<div id="view-alarm" class="screen">
    <h1 style="font-size:50px; background:white; color:black; padding:10px;">TIME UP</h1>
    <div style="margin-top:20px; color:red;">SOLVE TO STOP</div>
    <div style="margin-top:30px; font-size:18px; font-weight:bold;" id="pen-q">?</div>
    <div id="pen-area" style="margin-top:20px; width:100%;"></div>
</div>

<div id="view-admin" class="screen" style="border:4px solid var(--primary);">
    <div style="font-size:10px; color:#0f0;">ADMIN CONSOLE</div>
    
    <div id="request-box" style="display:none; border:1px solid orange; padding:10px; margin:20px 0; width:100%;">
        <div style="color:orange;">UNLOCK REQUEST</div>
        <button class="btn" onclick="respond(true)" style="background:green; margin-top:5px;">APPROVE</button>
        <button class="btn" onclick="respond(false)" style="background:red; margin-top:5px;">DENY</button>
    </div>
    
    <hr style="border-color:#333; width:100%; margin:20px 0;">
    <input id="target-id" class="inp" placeholder="Paste Student ID Here">
    <button class="btn" onclick="remoteUnlock()" style="padding:10px;">FORCE UNLOCK</button>
    
    <hr style="border-color:#333; width:100%; margin:20px 0;">
    <label style="font-size:10px; color:#888;">PIN OFFSET (TYPE 25 FOR 25+HOUR)</label>
    <input type="number" id="inp-offset" class="inp" value="25">
    <button class="btn" onclick="saveOffset()" style="padding:10px;">SAVE CONFIG</button>
    
    <button class="btn" onclick="resetCheatCount()" style="border-color:orange; color:orange; margin-top:20px;">RESET CHEAT COUNT</button>
</div>

<script>
    // --- CONFIG ---
    const DB = {
        role: localStorage.getItem('omg_role'),
        offset: parseInt(localStorage.getItem('omg_offset')) || 25, 
        unlocks: parseInt(localStorage.getItem('omg_unlocks')) || 0,
        cheatCount: parseInt(localStorage.getItem('omg_cheats')) || 0,
        lastReset: parseInt(localStorage.getItem('omg_reset_day')) || 0
    };
    
    // --- QUESTION BANKS ---
    const EASY_Q = [
        {q:"Unit of Force?", o:["Newton","Joule","Watt","Volt"], a:0},
        {q:"Value of g?", o:["9.8","10","9.2","8.9"], a:0},
        {q:"pH of Water?", o:["7","1","14","0"], a:0},
        {q:"Powerhouse of Cell?", o:["Mitochondria","Nucleus","Ribosome","Lysosome"], a:0},
        {q:"Sin(90)?", o:["1","0","-1","Inf"], a:0},
        {q:"Lightest Gas?", o:["Hydrogen","Helium","Oxygen","Nitrogen"], a:0},
        {q:"Charge of Electron?", o:["Negative","Positive","Neutral","Variable"], a:0},
        {q:"Ohm's Law?", o:["V=IR","V=I/R","I=VR","R=VI"], a:0},
        {q:"Boiling point of water?", o:["100C","0C","50C","200C"], a:0},
        {q:"Pi approx?", o:["3.14","3.41","3.11","3.00"], a:0},
        {q:"Atomic No. of Carbon?", o:["6","12","8","14"], a:0},
        {q:"Speed of Light?", o:["3x10^8","3x10^6","330","Infinite"], a:0}
    ];

    const HARD_Q = [
        {q:"Force if m=15kg, a=12m/s^2?", o:["180 N","150 N","120 N","200 N"], a:0},
        {q:"Work: F=20N, d=15m, angle=60?", o:["150 J","300 J","100 J","200 J"], a:0},
        {q:"Resistance: V=220V, I=5A?", o:["44 Ohm","50 Ohm","110 Ohm","22 Ohm"], a:0},
        {q:"Kinetic Energy: m=10kg, v=4m/s?", o:["80 J","40 J","160 J","20 J"], a:0},
        {q:"Moles in 88g CO2?", o:["2 mol","1 mol","4 mol","0.5 mol"], a:0},
        {q:"Root of x^2 - 5x + 6 = 0?", o:["2, 3","1, 6","-2, -3","2, -3"], a:0},
        {q:"Calculate 15% of 1500?", o:["225","150","200","250"], a:0},
        {q:"Time period if f=50Hz?", o:["0.02s","0.2s","0.05s","0.5s"], a:0}
    ];

    let state = { 
        peer: null, conn: null, alarmOsc: null, sessionInt: null,
        holdTimer: null, alarmActive: false,
        qIdx: 0, currentQs: [], qType: 'easy', denialTaps: 0,
        myPeerId: "Generating..."
    };

    // --- INIT ---
    const today = new Date().getDate();
    if(DB.lastReset !== today) { 
        DB.unlocks = 0; 
        DB.cheatCount = 0;
        DB.lastReset = today; 
        localStorage.setItem('omg_unlocks', 0); 
        localStorage.setItem('omg_cheats', 0);
        localStorage.setItem('omg_reset_day', today); 
    }

    window.onload = () => {
        document.getElementById('unlock-count').innerText = DB.unlocks;
        document.getElementById('cheat-count').innerText = DB.cheatCount;
        updateNetStat();
        window.addEventListener('online', updateNetStat);
        window.addEventListener('offline', updateNetStat);
        if(navigator.onLine) initPeer();
    };

    function updateNetStat() {
        const el = document.getElementById('net-stat');
        if(navigator.onLine) { el.innerText = "ONLINE"; el.style.color = "#0f0"; }
        else { el.innerText = "OFFLINE"; el.style.color = "#555"; }
    }

    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            if (document.getElementById('view-quiz').classList.contains('active')) {
                if (DB.cheatCount >= 3) {
                    sfx('err');
                    alert("CHEAT LIMIT REACHED (3/3). TAB SWITCHING DISABLED.");
                    location.reload(); 
                } else {
                    DB.cheatCount++;
                    localStorage.setItem('omg_cheats', DB.cheatCount);
                    document.getElementById('cheat-count').innerText = DB.cheatCount;
                }
            }
            if(state.alarmActive && state.alarmOsc) { state.alarmOsc.stop(); state.alarmOsc=null; }
            if(navigator.vibrate) navigator.vibrate(0);
        } else {
            if(state.alarmActive) triggerAlarmLoop();
        }
    });

    // --- PEERJS & QR CODE ---
    function initPeer() {
        state.peer = new Peer(null, { debug: 1 });
        state.peer.on('open', (id) => {
            state.myPeerId = id;
            document.getElementById('disp-peer-id').innerText = id;
            
            // GENERATE QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: id,
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            if(DB.role === 'student') {
                const adminId = localStorage.getItem('omg_admin_id');
                if(adminId) state.conn = state.peer.connect(adminId);
            }
        });
        state.peer.on('connection', (c) => {
            state.conn = c;
            setupConn();
            if(DB.role === 'admin') document.getElementById('request-box').style.display = 'block';
        });
    }
    
    function copyId() {
        if(state.myPeerId) {
            navigator.clipboard.writeText(state.myPeerId);
            alert("ID COPIED!");
        }
    }

    function setupConn() {
        state.conn.on('data', (d) => {
            if(DB.role === 'student') {
                if(d.type === 'approve') unlockSuccess();
                if(d.type === 'deny') { alert("DENIED"); location.reload(); }
            }
        });
        if(DB.role === 'student') localStorage.setItem('omg_admin_id', state.conn.peer);
    }

    // --- ADMIN ---
    function startHold() { 
        document.getElementById('admin-trigger').classList.add('holding');
        state.holdTimer = setTimeout(checkDeviceAndShow, 5000); 
    }
    function endHold() { 
        document.getElementById('admin-trigger').classList.remove('holding');
        clearTimeout(state.holdTimer); 
    }
    
    function checkDeviceAndShow() {
        show('view-auth');
        const isMobile = /Android|iPhone/i.test(navigator.userAgent);
        if(isMobile) {
            document.getElementById('device-warning').style.display = 'block';
            document.getElementById('admin-login-area').style.display = 'none';
            document.getElementById('user-agent-disp').innerText = navigator.userAgent.substring(0, 20) + "...";
        } else {
            document.getElementById('device-warning').style.display = 'none';
            document.getElementById('admin-login-area').style.display = 'block';
        }
        state.denialTaps = 0; 
    }

    function bypassDenial() {
        state.denialTaps++;
        if(state.denialTaps >= 3) {
            document.getElementById('device-warning').style.display = 'none';
            document.getElementById('admin-login-area').style.display = 'block';
        }
    }

    function verifyAdmin() {
        const p = document.getElementById('admin-pass').value;
        if(p === "admin123" || p === "!admin123") {
            DB.role = 'admin'; localStorage.setItem('omg_role', 'admin');
            show('view-admin');
        } else {
            alert("ACCESS DENIED"); location.reload();
        }
    }

    // --- QUIZ ---
    function startFlow() {
        DB.role = 'student'; localStorage.setItem('omg_role', 'student');
        if (DB.unlocks === 0) {
            state.qType = 'easy';
            state.currentQs = [...EASY_Q].sort(() => 0.5 - Math.random()).slice(0, 10);
            startQuiz();
        } else if (DB.unlocks === 1) {
            state.qType = 'mixed';
            const easyPart = [...EASY_Q].sort(() => 0.5 - Math.random()).slice(0, 4);
            const hardPart = [...HARD_Q].sort(() => 0.5 - Math.random()).slice(0, 1);
            state.currentQs = [...easyPart, ...hardPart].sort(() => 0.5 - Math.random());
            startQuiz();
        } else {
            checkQuota();
        }
    }

    function startQuiz() {
        state.qIdx = 0;
        document.getElementById('q-total').innerText = state.currentQs.length;
        document.getElementById('quiz-type').innerText = state.qType === 'easy' ? "WARMUP" : "GAUNTLET";
        show('view-quiz'); 
        loadQ();
    }

    function loadQ() {
        if(state.qIdx >= state.currentQs.length) { unlockSuccess(); return; }
        const q = state.currentQs[state.qIdx];
        document.getElementById('q-idx').innerText = state.qIdx + 1;
        document.getElementById('q-text').innerText = q.q;
        const div = document.getElementById('mc-area'); div.innerHTML = '';
        let opts = q.o.map((txt, i) => ({txt, isCorr: i === q.a}));
        opts.sort(() => 0.5 - Math.random());
        opts.forEach(o => {
            let b = document.createElement('div'); b.className = 'btn'; b.style.marginTop='10px'; b.innerText = o.txt;
            b.onclick = () => { if(o.isCorr) { state.qIdx++; loadQ(); } else { alert("WRONG. RESTARTING."); location.reload(); } };
            div.appendChild(b);
        });
    }

    function checkQuota() {
        if(navigator.onLine) {
            show('view-wait');
            if(state.conn) state.conn.send({ type: 'request' });
        } else {
            alert("QUOTA EXCEEDED. CONNECT INTERNET.");
            location.reload();
        }
    }

    // --- TRANSITION TO ANIMATION ---
    function unlockSuccess() {
        playConnectionAnim();
    }

    // NEW: ANIMATION LOGIC
    function playConnectionAnim() {
        show('view-anim');
        const bar = document.getElementById('anim-bar');
        const log = document.getElementById('anim-log');
        let width = 0;
        
        const logs = [
            "CONNECTING TO APPLOCK DAEMON...",
            "VERIFYING INTEGRITY...",
            "BYPASSING SECURITY LAYER 1...",
            "SYNCING TIME SYNC...",
            "GENERATING 25+ HASH...",
            "CONNECTION ESTABLISHED."
        ];
        
        let i = 0;
        const int = setInterval(() => {
            width += 2;
            bar.style.width = width + "%";
            
            if(width % 20 === 0 && i < logs.length) {
                log.innerText += "\n" + logs[i];
                log.scrollTop = log.scrollHeight;
                i++;
            }
            
            if(width >= 100) {
                clearInterval(int);
                setTimeout(revealPin, 500);
            }
        }, 50); // 2.5 seconds total
    }

    function revealPin() {
        if(DB.unlocks < 2) { DB.unlocks++; localStorage.setItem('omg_unlocks', DB.unlocks); }
        
        const now = new Date();
        const hour = now.getHours().toString().padStart(2,'0'); 
        
        // PIN FIX: STRING CONCATENATION
        const finalPin = DB.offset.toString() + hour; 
        
        document.getElementById('final-pin').innerText = finalPin;
        show('view-reveal');
        setTimeout(() => startSession(45), 5000);
    }

    // --- SESSION ---
    function startSession(mins) {
        show('view-session');
        let t = mins * 60;
        state.sessionInt = setInterval(() => {
            t--;
            let m = Math.floor(t/60).toString().padStart(2,'0');
            let s = (t%60).toString().padStart(2,'0');
            document.getElementById('sess-time').innerText = `${m}:${s}`;
            if(t<=0) { clearInterval(state.sessionInt); triggerAlarm(); }
        }, 1000);
    }

    function triggerAlarm() {
        state.alarmActive = true;
        show('view-alarm');
        loadPenalty();
        triggerAlarmLoop();
    }

    function triggerAlarmLoop() {
        if(!state.alarmActive) return;
        if(document.hidden) { 
            if(state.alarmOsc) { state.alarmOsc.stop(); state.alarmOsc=null; }
            if(navigator.vibrate) navigator.vibrate(0);
            return; 
        }
        document.body.classList.add('strobe');
        if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = 'square'; osc.connect(ctx.destination); osc.start();
        state.alarmOsc = osc;
        let high = false;
        let int = setInterval(() => {
            if(!state.alarmOsc) { clearInterval(int); return; }
            osc.frequency.value = high ? 800 : 1200; high = !high;
        }, 200);
    }

    function loadPenalty() {
        const q = HARD_Q[Math.floor(Math.random()*HARD_Q.length)];
        document.getElementById('pen-q').innerText = q.q;
        const div = document.getElementById('pen-area'); div.innerHTML = '';
        let opts = q.o.map((txt, i) => ({txt, isCorr: i === q.a}));
        opts.sort(() => 0.5 - Math.random());
        opts.forEach(o => {
            let b = document.createElement('div'); b.className = 'btn'; b.style.marginTop='10px'; b.innerText = o.txt;
            b.onclick = () => { if(o.isCorr) stopAlarm(); else { alert("WRONG. TRY AGAIN."); loadPenalty(); } };
            div.appendChild(b);
        });
    }

    function stopAlarm() {
        state.alarmActive = false;
        document.body.classList.remove('strobe');
        if(state.alarmOsc) { state.alarmOsc.stop(); state.alarmOsc = null; }
        if(navigator.vibrate) navigator.vibrate(0);
        location.reload();
    }

    // --- ADMIN ---
    function remoteUnlock() {
        const id = document.getElementById('target-id').value;
        const c = state.peer.connect(id);
        c.on('open', () => c.send({ type: 'approve' }));
    }
    
    function respond(ok) {
        state.conn.send({ type: ok ? 'approve' : 'deny' });
        document.getElementById('request-box').style.display = 'none';
    }
    
    function saveOffset() {
        const o = document.getElementById('inp-offset').value;
        if(o) localStorage.setItem('omg_offset', o);
        alert("SAVED");
    }
    
    function resetCheatCount() {
        DB.cheatCount = 0;
        localStorage.setItem('omg_cheats', 0);
        alert("CHEAT COUNT RESET");
    }

    function show(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function sfx(t) { const c=new (window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); o.connect(c.destination); o.start(); setTimeout(()=>o.stop(),200); }

</script>
</body>
        </html>
